{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation BLAH **WARNING** This template creates an Amazon EC2 instance. You will be billed for the AWS resources used if you create a stack from this template.",
    "Outputs": {
        "EndPointAddress": {
            "Export": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "EndpointAddress"
                        ]
                    ]
                }
            },
            "Value": {
                "Fn::GetAtt": [
                    "AuroraPostgresCluster",
                    "Endpoint.Address"
                ]
            }
        },
        "Port": {
            "Export": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "Port"
                        ]
                    ]
                }
            },
            "Value": {
                "Fn::GetAtt": [
                    "AuroraPostgresCluster",
                    "Endpoint.Port"
                ]
            }
        },
        "ReadEndPointAddress": {
            "Export": {
                "Name": {
                    "Fn::Join": [
                        "-",
                        [
                            {
                                "Ref": "AWS::StackName"
                            },
                            "ReadEndpointAddress"
                        ]
                    ]
                }
            },
            "Value": {
                "Fn::GetAtt": [
                    "AuroraPostgresCluster",
                    "ReadEndpoint.Address"
                ]
            }
        }
    },
    "Parameters": {
        "DatabaseName": {
            "Default": "jackdb",
            "Description": "=DatabaseName",
            "Type": "String"
        },
        "FirewallStackName": {
            "Default": "Firewall-Stack",
            "Description": "=FirewallStackName",
            "Type": "String"
        },
        "IAMStackName": {
            "Default": "IAM-Stack",
            "Description": "IAMStackName",
            "Type": "String"
        },
        "MasterUserPassword": {
            "Default": "11223344",
            "Description": "=MasterUserPassword",
            "Type": "String"
        },
        "MasterUsername": {
            "Default": "jack",
            "Description": "=MasterUsername",
            "Type": "String"
        },
        "NetworkingStackName": {
            "Default": "Networking-Stack",
            "Description": "NetworkingStackName",
            "Type": "String"
        }
    },
    "Resources": {
        "AuroraPostgresCluster": {
            "Properties": {
                "DBClusterParameterGroupName": "default.aurora-postgresql10",
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "DatabaseName": {
                    "Ref": "DatabaseName"
                },
                "Engine": "aurora-postgresql",
                "EngineMode": "provisioned",
                "EngineVersion": "10.5",
                "KmsKeyId": {
                    "Fn::ImportValue": {
                        "Fn::Sub": "${IAMStackName}-DBKeyArn"
                    }
                },
                "MasterUserPassword": {
                    "Ref": "MasterUserPassword"
                },
                "MasterUsername": {
                    "Ref": "MasterUsername"
                },
                "Port": 5432,
                "StorageEncrypted": "true",
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ],
                "VpcSecurityGroupIds": [
                    {
                        "Fn::ImportValue": {
                            "Fn::Sub": "${FirewallStackName}-DBSG"
                        }
                    }
                ]
            },
            "Type": "AWS::RDS::DBCluster"
        },
        "AuroraPostgresInstance": {
            "Properties": {
                "CopyTagsToSnapshot": "true",
                "DBClusterIdentifier": {
                    "Ref": "AuroraPostgresCluster"
                },
                "DBInstanceClass": "db.r4.large",
                "DBInstanceIdentifier": "jackdbinstance",
                "DBParameterGroupName": "default.aurora-postgresql10",
                "DBSubnetGroupName": {
                    "Ref": "DBSubnetGroup"
                },
                "EnablePerformanceInsights": "true",
                "Engine": "aurora-postgresql",
                "StorageEncrypted": "true",
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            },
            "Type": "AWS::RDS::DBInstance"
        },
        "DBSubnetGroup": {
            "Properties": {
                "DBSubnetGroupDescription": "Aurora Postgres Subnet Group",
                "DBSubnetGroupName": "aurora-postgres-subnet-group",
                "SubnetIds": [
                    {
                        "Fn::ImportValue": {
                            "Fn::Sub": "${NetworkingStackName}-SubnetId7"
                        }
                    },
                    {
                        "Fn::ImportValue": {
                            "Fn::Sub": "${NetworkingStackName}-SubnetId8"
                        }
                    }
                ],
                "Tags": [
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            },
            "Type": "AWS::RDS::DBSubnetGroup"
        }
    }
}